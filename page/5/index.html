<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="fucchen.dc">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="fucchen.dc">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="cfc">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>fucchen.dc</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fucchen.dc</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/pfc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/pfc/" itemprop="url">pfc</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:24:05+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/unable-to-receive-any-multicast-traffic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/unable-to-receive-any-multicast-traffic/" itemprop="url">unable to receive any multicast traffic</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:20:51+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/N3K-traffic-uneven/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/N3K-traffic-uneven/" itemprop="url">N3K traffic uneven</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:18:32+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/can-t-receive-multicast-traffic-every-5-mins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/can-t-receive-multicast-traffic-every-5-mins/" itemprop="url">can't receive multicast traffic every 5 mins</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:17:45+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/eigrp-flapping/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/eigrp-flapping/" itemprop="url">eigrp flapping</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:17:07+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/ospf-stuck-in-exstart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/ospf-stuck-in-exstart/" itemprop="url">MTU问题导致ospf卡在EXSTART状态</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:16:43+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>涉及的主机名/IP/MAC/端口编号已改</li>
</ul>
<h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>客户N9K L2直连Server，并用SVI和Server建ospf，但邻居卡在EXSTART状态</p>
<p>客户Server MTU配置了9292，</p>
<p>由于LAB能复现，直接说下LAB的情况</p>
<p>拓扑<br>N9K-e1/2(L2)——IXIA                // IXIA模拟Server，设置MTU 9216<br>N9K SVI 100 MTU 9000; e1/2 MTU 1500   // 总之控制Server MTU大于对端N9K SVI100 MTU就行</p>
<h3 id="故障分析"><a href="#故障分析" class="headerlink" title="故障分析"></a>故障分析</h3><p>问题答案如以下RFC文档所述：</p>
<p>If the Interface MTU field in the Database Description packet indicates an IP datagram size that is larger than the router can accept on the receiving interface without fragmentation, the Database Description packet is rejected. </p>
<p>意思是如果本端收到的DBD报文中携带的MTU值，大于本端的MTU，这样的DBD被丢弃，所以一直卡在DBD交互阶段，导致后续OSPF起不来</p>
<p>在N9K侧，可以看到有如下log指示收到的DBD中MTU字段过大</p>
<p>That’s why I can see the following log on your N9K<br>2019 Aug  5 10:12:06.255029 ospf 100 [25732]: :     DBD from 10.x.x.x mtu too large &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</p>
<p>以下是LAB的输出，LAB N9K tx DBD携带的MTU为9000，rx DBD携带的MTU为9216，所以最终OSPF就卡在EXSTART上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>DBD sent <span class="keyword">from</span> N9K, <span class="number">9000</span> <span class="keyword">is</span> inherited by SVI MTU <span class="number">9000</span></span><br><span class="line"></span><br><span class="line">ethanalyzer local interface inband display-filter <span class="string">"ospf and ip.addr==10.1.1.1"</span> detail</span><br><span class="line">…snip…</span><br><span class="line">OSPF DB Description</span><br><span class="line">        Interface MTU: <span class="number">9000</span></span><br><span class="line">        Options: <span class="number">0x42</span> (O, E)</span><br><span class="line">            <span class="number">0.</span>.. .... = DN: DN-bit <span class="keyword">is</span> NOT set</span><br><span class="line">            <span class="number">.1</span>.. .... = O: O-bit <span class="keyword">is</span> SET</span><br><span class="line">            .<span class="number">.0</span>. .... = DC: Demand circuits are NOT supported</span><br><span class="line">            ..<span class="number">.0</span> .... = L: The packet does NOT contain LLS data block</span><br><span class="line">            .... <span class="number">0.</span>.. = NP: Nssa <span class="keyword">is</span> NOT supported</span><br><span class="line">            .... <span class="number">.0</span>.. = MC: NOT multicast capable</span><br><span class="line">            .... .<span class="number">.1</span>. = E: ExternalRoutingCapability</span><br><span class="line">        DB Description: <span class="number">0x07</span> (I, M, MS)</span><br><span class="line">            .... <span class="number">0.</span>.. = R: OOBResync bit <span class="keyword">is</span> NOT set</span><br><span class="line">            .... <span class="number">.1</span>.. = I: Init bit <span class="keyword">is</span> SET</span><br><span class="line">            .... .<span class="number">.1</span>. = M: More bit <span class="keyword">is</span> SET</span><br><span class="line">            .... ..<span class="number">.1</span> = MS: Master/Slave bit <span class="keyword">is</span> SET</span><br><span class="line">        DD Sequence: <span class="number">265289436</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>DBD sent <span class="keyword">from</span> IXIA, MTU <span class="keyword">is</span> set <span class="keyword">with</span> MTU <span class="number">9216</span>, which <span class="keyword">is</span> greater than MTU <span class="number">9000</span> sent <span class="keyword">from</span> N9K</span><br><span class="line"></span><br><span class="line">ethanalyzer local interface inband display-filter <span class="string">"ospf and ip.addr==10.1.1.2"</span> detail</span><br><span class="line">…snip…</span><br><span class="line">OSPF DB Description</span><br><span class="line">        Interface MTU: <span class="number">9216</span></span><br><span class="line">        Options: <span class="number">0x02</span> (E)</span><br><span class="line">            <span class="number">0.</span>.. .... = DN: DN-bit <span class="keyword">is</span> NOT set</span><br><span class="line">            <span class="number">.0</span>.. .... = O: O-bit <span class="keyword">is</span> NOT set</span><br><span class="line">            .<span class="number">.0</span>. .... = DC: Demand circuits are NOT supported</span><br><span class="line">            ..<span class="number">.0</span> .... = L: The packet does NOT contain LLS data block</span><br><span class="line">            .... <span class="number">0.</span>.. = NP: Nssa <span class="keyword">is</span> NOT supported</span><br><span class="line">            .... <span class="number">.0</span>.. = MC: NOT multicast capable</span><br><span class="line">           .... .<span class="number">.1</span>. = E: ExternalRoutingCapability</span><br><span class="line">        DB Description: <span class="number">0x07</span> (I, M, MS)</span><br><span class="line">            .... <span class="number">0.</span>.. = R: OOBResync bit <span class="keyword">is</span> NOT set</span><br><span class="line">            .... <span class="number">.1</span>.. = I: Init bit <span class="keyword">is</span> SET</span><br><span class="line">            .... .<span class="number">.1</span>. = M: More bit <span class="keyword">is</span> SET</span><br><span class="line">            .... ..<span class="number">.1</span> = MS: Master/Slave bit <span class="keyword">is</span> SET</span><br><span class="line">        DD Sequence: <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Then OSPF neighbor stuck <span class="keyword">in</span> EXSTART</span><br><span class="line"></span><br><span class="line">sh ip os  neighbors</span><br><span class="line"> OSPF Process ID <span class="number">1</span> VRF default</span><br><span class="line">Total number of neighbors: <span class="number">1</span></span><br><span class="line">Neighbor ID     Pri State            Up Time  Address         Interface</span><br><span class="line"><span class="number">192.0</span><span class="number">.0</span><span class="number">.1</span>         <span class="number">0</span> EXSTART/DROTHER  <span class="number">00</span>:<span class="number">09</span>:<span class="number">56</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.2</span>        Vlan10</span><br></pre></td></tr></table></figure>






          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/uneven/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/uneven/" itemprop="url">uneven'</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:15:33+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/sla-down/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/sla-down/" itemprop="url">sla down</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:14:51+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>涉及的主机名/IP/MAC/端口编号已改</li>
</ul>
<h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>客户I75a &amp; N9K下，有这么个配置：</p>
<p>track 1 ip sla 1 reachability<br>track 2 ip sla 2 reachability<br>track 3 ip sla 3 reachability<br>track 4 ip sla 4 reachability<br>track 5 ip sla 4 reachability</p>
<p>track 15 list boolean or<br>  object 1<br>  object 2<br>  object 3<br>  object 4<br>  object 5</p>
<p>大概是这样：VxLAN环境下，leaf上定义了5个SLA，这5个SLA会通过icmp探针，探测远端某个border-leaf的可达性，每个SLA追溯的border-leaf都不同，这些LSA都各自关联到小track，随后定义了一个大track把这些小track或起来，然后写了个EEM策略，当大track down时，做自动shut所有端口的action，客户逻辑是大track down表明所有小track都down了，即所有border-leaf均不可达，为保护下游server，于是这台设备shut所有端口做自我隔离</p>
<p>客户某天发现大track down触发了隔离行为，于是来追溯当时大track down的原因，track down后过了5秒自动又up</p>
<h3 id="故障分析"><a href="#故障分析" class="headerlink" title="故障分析"></a>故障分析</h3><p>1/ 大track down，说明小track故障瞬间全down，小track全down说明，说明故障瞬间发送到所有border-leaf的icmp探针全部没发出/发出的探针丢在request方向丢在沿途/发出的探针在reply方向丢在沿途/发出的探针在reply方向丢在本端/接口层面包收发都没丢但SLA进程未处理reply回包/这种瞬时故障立刻恢复的可能性实在太多，不好查。</p>
<p>2/ 检查了接口counter都很干净，检查COPP counter，唯一有drop并且有增长的地方是default-copp，但sla使用的是icmp探针，要icmp reply真丢在本端，理论上也该是丢在icmp copp queue里，所以其实很难说故障瞬时丢的5个ICMP包就是丢在这台leaf上</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">monitoring</span> <span class="params">(match-any)</span>    &gt;&gt;&gt;&gt;&gt;&gt; <span class="title">monitoring</span> <span class="title">queue</span></span></span><br><span class="line"><span class="class">  <span class="title">match</span> <span class="title">access</span>-<span class="title">group</span> <span class="title">name</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">acl</span>-<span class="title">icmp</span></span></span><br><span class="line"><span class="class">  <span class="title">match</span> <span class="title">access</span>-<span class="title">group</span> <span class="title">name</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">acl</span>-<span class="title">icmp6</span></span></span><br><span class="line"><span class="class">  <span class="title">match</span> <span class="title">access</span>-<span class="title">group</span> <span class="title">name</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">acl</span>-<span class="title">traceroute</span></span></span><br><span class="line"><span class="class">  <span class="title">set</span> <span class="title">cos</span> 1</span></span><br><span class="line">  police cir 360 kbps , bc 128000 bytes </span><br><span class="line">  module <span class="number">1</span> :</span><br><span class="line">    transmitted <span class="number">16060</span> bytes;                            </span><br><span class="line">    dropped <span class="number">0</span> bytes;                        &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; ICMP COPP Queue没有丢包                  </span><br><span class="line">    monitoring queue transmitted <span class="number">16060</span> bytes, drop <span class="number">0</span> bytes</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">class</span>-<span class="title">default</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">  <span class="title">set</span> <span class="title">cos</span> 0</span></span><br><span class="line">  police cir 400 kbps , bc 32000 bytes </span><br><span class="line">  module <span class="number">1</span> :</span><br><span class="line">    transmitted <span class="number">20869421401</span> bytes;</span><br><span class="line">    dropped 512670 bytes;  		            &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; COPP Q里唯一有drop的是class-default                                            default queue transmitted 20869421401 bytes, drop 512670 bytes</span><br></pre></td></tr></table></figure>

<p>3/ 之后客户的track又down了一次，这一次把copp又拿过来和第一次收集的信息进行对比，发现大问题了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">monitoring</span> <span class="params">(match-any)</span>      &gt;&gt;&gt;&gt;&gt;&gt; <span class="title">monitoring</span> <span class="title">queue</span></span></span><br><span class="line"><span class="class">  <span class="title">match</span> <span class="title">access</span>-<span class="title">group</span> <span class="title">name</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">acl</span>-<span class="title">icmp</span></span></span><br><span class="line"><span class="class">  <span class="title">match</span> <span class="title">access</span>-<span class="title">group</span> <span class="title">name</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">acl</span>-<span class="title">icmp6</span></span></span><br><span class="line"><span class="class">  <span class="title">match</span> <span class="title">access</span>-<span class="title">group</span> <span class="title">name</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">acl</span>-<span class="title">traceroute</span></span></span><br><span class="line"><span class="class">  <span class="title">set</span> <span class="title">cos</span> 1</span></span><br><span class="line">  police cir 360 kbps , bc 128000 bytes </span><br><span class="line">  module <span class="number">1</span> :</span><br><span class="line">    transmitted <span class="number">16060</span> bytes;                           </span><br><span class="line">    dropped <span class="number">0</span> bytes;                     &lt;&lt;&lt;&lt;&lt;&lt; dropped没涨就算了，trasmitted也没涨，肯定说明我们这里的sla流量没有落到这个Q里 </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">class</span>-<span class="title">default</span> <span class="params">(match-any)</span> </span></span><br><span class="line"><span class="class">  <span class="title">set</span> <span class="title">cos</span> 0</span></span><br><span class="line">  police cir 400 kbps , bc 32000 bytes </span><br><span class="line">  module <span class="number">1</span> :</span><br><span class="line">    transmitted <span class="number">22253226046</span> bytes; </span><br><span class="line">    dropped <span class="number">14953655</span> bytes;              &lt;&lt;&lt;&lt;&lt;&lt; 后来在LAB里证实vxlan下icmp_based_sla的流量都落到这个queue里了</span><br></pre></td></tr></table></figure>

<p>4/ 这个COPP计数记错queue的问题匹配如下bug，简单说就是VxLAN环境下，在某些版本下，icmp包会错误地计数到copp default queue里</p>
<p>CSCvn37878 Ping to N9k VXLAN VTEP Tenant IP address dropped in CoPP Class Default</p>
<p>Symptom:<br>VXLAN VTEP Tenant IP address dropped in CoPP Class Default due to packet wrong classification.</p>
<p>Conditions:<br>This is seen on 7.0(3)I7(5), I7(5a).</p>
<p><a href="https://bst.cloudapps.cisco.com/bugsearch/bug/CSCvn37878" target="_blank" rel="noopener">https://bst.cloudapps.cisco.com/bugsearch/bug/CSCvn37878</a></p>
<p>所以结合这些信息，root cause是：受bug CSCvn37878影响下，icmp_based sla在vxlan环境下，sla探针的icmp reply会在copp default queue里计数，而我们看到平常的时候copp-default queue就一直在丢包（说明存在诸如某些tcp/udp过量上到CPU，并且速率超过CoPP设置默认阈值的现象）所以在故障时刻，发出的个sla探针的arp reply在同一秒，这5个icmp reply同时被本端copp default queue drop掉，导致所有SLA瞬时全down，而下一次探测时（frequency == 5s），5个新的SLA探测只要有1个能成功得到相应，就能把大track重新bring up回来</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>1/ 升级到CSCvn37878修复版本解决CoPP异常计数的问题</p>
<p>2/ 增加CoPP default queue阈值，这个其实不建议</p>
<p>3/ 给这个SLA的流量专门定义一个CoPP Queue，避免其他异常流量的干扰</p>
<p>4/ SLA/track re-design，track监控上联到spine的接口状态，如果探测到所有上联接口全down，再shut所有端口自我隔离;</p>
<p>毕竟某一秒发出的5个探针包同时丢了，就整机隔离，也不太符合客户的实际需求。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/vxlan-packet-loss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/vxlan-packet-loss/" itemprop="url">vxlan double rmac问题导致丢流不通的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T23:04:21+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>涉及的主机名/IP/MAC/端口编号已改</li>
</ul>
<h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>这个故障有点久，故障描述什么的只能大概齐回忆写一下</p>
<p>拓扑：</p>
<p><img src="http://qa2m8sna1.bkt.clouddn.com/VxLAN1-1.png" alt="vxlan1-1 topo"></p>
<p>新上环境，两个问题</p>
<p>问题1：两台leaf的show nve peer看不到border-leaf</p>
<p>问题2：PC1 136.6 ping 132.6不通，不同网段</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>1/ 问题1，检查了邻居leaf和border-leaf的邻居是正常建立的，但leaf没有收到border过来的bgp路由，这个是正常现象，因为建立nve peer的前提是需要有peer从远端传来evpn 路由，即通过路由驱动nve peer的建立。随后验证这个就在border上串了一台PC，随后leaf nve peer就可以看到border-leaf</p>
<p>2/ 问题2，leaf-01上查看RIB，指示type-5 evpn路由走默认路由到N9K-05-bl上</p>
<p>3/ 由于测试环境无流量，于是沿途ELAM + SPAN_TO_CPU抓包确定转发路径，发现request方向的ICMP包最终落到最后一跳N9K-05-bl上，然后被丢弃，没有转给PC2，所以丢包点为N9-05-bl</p>
<p>4/ 通过elam detail或者SPAN把detail报文展开，发现N9K-05-bl的内层IP首部中的目的MAC并非N9K-05-bl自己的RMAC(router mac，对于带IP的type 2 evpn路由以及type 5 evpn路由，会携带上rmac，evpn路由传递时，rmac裹在extended community中)</p>
<p>5/ google了下封装错的这个MAC，竟然是个Arista MAC，吃一鲸后继续查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Ethernet II, Src: d4:c9:<span class="number">3</span>c:xx:xx:xx (d4:c9:<span class="number">3</span>c:xx:xx:xx), Dst: f8:<span class="number">0</span>f:<span class="number">6</span>f:<span class="number">9</span>a:f8:d9 (f8:<span class="number">0</span>f:<span class="number">6</span>f:<span class="number">9</span>a:f8:d9)    &lt;&lt;&lt; 外层L2头部</span><br><span class="line"></span><br><span class="line">Internet Protocol, Src: <span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span> (<span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span>), Dst: <span class="number">10.1</span><span class="number">.1</span><span class="number">.5</span> (<span class="number">10.1</span><span class="number">.1</span><span class="number">.5</span>)                &lt;&lt;&lt; 外层L3头部</span><br><span class="line"></span><br><span class="line">User Datagram Protocol, Src Port: <span class="number">59987</span> (<span class="number">59987</span>), Dst Port: <span class="number">4789</span> (<span class="number">4789</span>)</span><br><span class="line"></span><br><span class="line">Virtual eXtensible Local Area Network</span><br><span class="line"></span><br><span class="line">Ethernet II, Src: d4:c9:<span class="number">3</span>c:xx:xx:xx (d4:c9:<span class="number">3</span>c:xx:xx:xx), Dst: <span class="number">28</span>:<span class="number">99</span>:<span class="number">3</span>a:xx:xx:xx (<span class="number">28</span>:<span class="number">99</span>:<span class="number">3</span>a:xx:xx:xx)   &lt;&lt;&lt; 内层L2头部</span><br><span class="line"></span><br><span class="line">Internet Protocol, Src: <span class="number">10.1</span><span class="number">.136</span><span class="number">.6</span> (<span class="number">10.1</span><span class="number">.136</span><span class="number">.6</span>), Dst: <span class="number">10.1</span><span class="number">.132</span><span class="number">.6</span> (<span class="number">10.1</span><span class="number">.132</span><span class="number">.6</span>)             &lt;&lt;&lt; 内层L3头部</span><br><span class="line"></span><br><span class="line">Internet Control Message Protocol</span><br><span class="line">    Type: <span class="number">8</span> (Echo (ping) request)</span><br></pre></td></tr></table></figure>

<p>6/ 由于解封装点N9K-05-bl收到的包inner dst mac封装错了，自然要回到封装该mac并发出报文的第一跳设备N9K-03-leaf上去看，也是通过SPAN_to_CPU方式看detail 报文，确实在发出报文的时候就封装了错误的inner dst mac</p>
<p>7/ 检查N9K-03-leaf学到的type 5 evpn 0.0路由，携带的rmac有两个，一个是正确的N9K-05-bl的rmac，一个就是错的arista mac，所以球踢回给N9K-05-bl</p>
<p>8/ 检查N9K-05-bl，0.0路由是从ipv4邻居PA学过来的，然后本地将该路由通过type-5 evpn的方式注入自己的VxLAN域中</p>
<p>9/ 检查N9K-05-bl从PA学到的ipv4 0.0路由，extended community中意外携带了Arista rmac，该mac就是上述封装错误的MAC</p>
<p>10/ 为了更好地石锤，flap连PA的入向口的同时，抓该接口rx bgp update，发现PA通告过来的NLRI ipv4 0.0/0中extended community中携带了不该携带的VxLAN属性，即RMAC</p>
<p>所以RCA基本有定论了：<br>N9-05-bl收到的ipv4 0.0路由中携带了VxLAN Arista RMAC，N9K-05-bl在对这样的路由生成type-5 evpn路由的时候直接继承了ipv4路由原有的rmac，所以控制平面，type-5 evpn路由在vxlan域中传递并让N9K-03-leaf收到后，该evpn路由携带了double rmac，这时候N9K-03-leaf的show nve peer毕竟也只会使用一个rmac，就可能选择了错误的arista rmac；在数据平面，N9K-03-leaf封装inner dst mac封装成了错误的rmac，N9K-05-bl解封装发现inner dst mac不是自己的rmac，将包丢弃</p>
<p>后续客户也追踪了下arista mac，说该MAC是PA上游远端遥远的一个Arista VxLAN Domain中的某台设备。其实这条0.0路由就是从Arista VxLAN Domain始发出来的evpn路由，然后穿越ipv4 bgp最后经过N9K-05-bl又重新变成evpn路由在传递</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>和客户解释了，PA传给N9K-05-bl的ipv4路由携带evpn路由的属性是没有意义的，并且PA传给N9K-05-bl的ipv4路由也没有特殊设置diy extended community的需求，所以最终客户也同意在PA做清洗属性的动作，即在PA出向remove all extended community</p>
<p>完结撒花</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/all-bgp-neighbor-down/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/all-bgp-neighbor-down/" itemprop="url">all bgp neighbor down</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-11T21:53:42+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>实际拓扑不好画，大概描述下，9516，和几百个TOR建了bgp邻居</p>
<p>故障是bgp邻居全down，嗯还是两台9516都挂球子了，自行脑补这事儿炸毛的场景（万幸是客户冗余做得好，没什么实际业务影响）</p>
<p>当时邻居全down后，客户把整机断电后开始要查，断电后通常syslog/bgp进程什么的log都刷没了，信息都不知道采什么，真酸爽。</p>
<p>唯一能追溯到有用的log报只有下面两条。</p>
<p>Could not allocate Attr. DB entry<br>BGP x.x.x.x shutdown due to no memory condition (Prefix cannot be added)</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>1/ 这个log的Attr是attribution的意思，其实就是bgp那些属性，AS_PATH / Community 这些</p>
<p>2/ 一开始其实没有把重点放在属性这个东西上，原因是这个客户之前遇到过由于BMP耗尽BGP内存导致邻居down的类似故障，所以第一反应是BGP自己的内存又因为某某原因耗尽了，根据log，怀疑是故障前设备收到burst前缀把bgp内存耗尽导致邻居down（断电过也没法从log判断这一点），开始的方向也一直是每隔几小时观察BGP进程内存以及系统内存使用情况。观察了一段时间，发现也没异常增长。</p>
<p>3/ 辗转了一会儿，意外发现，有个叫bgp share memory共享内存的东西，随着版本的不断迭代，不断扩容，后来证实bgp share memory正是存放bgp属性的地方，简单理解就是软件上给bgp前缀分了两块内存，其中一块内存专门放bgp前缀本身，另一块内存也就是共享内存专门存放bgp前缀所携带的属性</p>
<p>4/ 检查了客户的共享内存利用率，确实都90%，有些95%以上了，有了这个理论基础，自然怀疑是当时共享内存爆了导致邻居down</p>
<p>5/ 验证猜想，需要LAB重现，由于问题也在LAB复现了，所以说说LAB的复现情况</p>
<p>IXIA和9508建若干bgp邻居</p>
<p>IxNetwork不断打路由，并对这些路由随机附上一些random AS_PATH / community这些属性，LAB里单条前缀携带的属性会比较多</p>
<p>在总共打了将近20w路由的时候，问题复现，并且bgp占用的共享内存以及bgp属性占用的内存不断增加，以下是打路由期间每隔5s共享内存的占用情况，可以看到18:25:27时接近突破了共享内存阈值，随后同时间点18:25:27 所有邻居带着和客户一样的log down了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">18</span>:<span class="number">25</span>:<span class="number">10.895</span> GMT Mon Aug <span class="number">05</span> <span class="number">2019</span></span><br><span class="line"></span><br><span class="line">Time source <span class="keyword">is</span> NTP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show process mem shared | <span class="keyword">in</span> bgp</span><br><span class="line"></span><br><span class="line">bgp                    <span class="number">0X75128000</span>     <span class="number">65536</span>+ (<span class="number">65540</span>)   <span class="number">48645</span>      <span class="number">16891</span>      <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">18</span>:<span class="number">25</span>:<span class="number">16.504</span> GMT Mon Aug <span class="number">05</span> <span class="number">2019</span></span><br><span class="line"></span><br><span class="line">Time source <span class="keyword">is</span> NTP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show process mem shared | <span class="keyword">in</span> bgp</span><br><span class="line"></span><br><span class="line">bgp                    <span class="number">0X75128000</span>     <span class="number">65536</span>+ (<span class="number">65540</span>)   <span class="number">54770</span>      <span class="number">10766</span>      <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">18</span>:<span class="number">25</span>:<span class="number">22.115</span> GMT Mon Aug <span class="number">05</span> <span class="number">2019</span></span><br><span class="line"></span><br><span class="line">Time source <span class="keyword">is</span> NTP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show process mem shared | <span class="keyword">in</span> bgp</span><br><span class="line"></span><br><span class="line">bgp                    <span class="number">0X75128000</span>     <span class="number">65536</span>+ (<span class="number">65540</span>)   <span class="number">60876</span>       <span class="number">4660</span>      <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">18</span>:<span class="number">25</span>:<span class="number">27.698</span> GMT Mon Aug <span class="number">05</span> <span class="number">2019</span></span><br><span class="line"></span><br><span class="line">Time source <span class="keyword">is</span> NTP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show process mem shared | <span class="keyword">in</span> bgp</span><br><span class="line"></span><br><span class="line">bgp                    <span class="number">0X75128000</span>     <span class="number">65536</span>+ (<span class="number">65540</span>)   <span class="number">65341</span>        <span class="number">195</span>      <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">18</span>:<span class="number">25</span>:<span class="number">33.284</span> GMT Mon Aug <span class="number">05</span> <span class="number">2019</span></span><br><span class="line"></span><br><span class="line">Time source <span class="keyword">is</span> NTP</span><br></pre></td></tr></table></figure>

<p>这个LAB干的事儿其实就是验证前缀的属性存在share memory里，并且在属性过多的时候，会把share memory撑爆，并且导致share memory直接大量释放，可以看到利用率几乎归零，然后bgp邻居集体down</p>
<p>6/ 回过头看客户那儿的信息，基于邻居的数量以及从每个邻居学来的路由数量，估算大概齐单台9516就学到了近120w条路由，这些路由或多或少都携带了些属性，所以root cause大概率和我们的猜想一致。</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>1/ 优化网络，后来证实大部分路由都是无用路由，最后客户优化完印象中最后就剩几千条路由，优化后共享内存利用率是很低的</p>
<p>2/ 9.3.1开始共享内存从64M扩到了256M，所以升级也可以</p>
<p>回过头再看这个故障本身并不复杂，这里最关键的地方是故障重现，而复现方法无人尝试过，因此碰壁多次。</p>
<p>该故障印象最深刻的地方是：在Youtube上自学用IxNetwork打各种路由 &amp; 建各种邻居的方法，解了case，也感谢同事们提出了写宝贵思路和方向。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">cfc</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cfc</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
