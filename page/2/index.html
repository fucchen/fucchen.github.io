<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="fucchen.dc">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="fucchen.dc">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="cfc">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>fucchen.dc</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fucchen.dc</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/10/erspan-packet-loss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/10/erspan-packet-loss/" itemprop="url">启用erspan truncation后丢包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-10T13:04:42+08:00">
                2020-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>涉及的主机名/IP/MAC/端口编号已改</li>
</ul>
<h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>由于问题能在LAB重现，就直接描述LAB的情况了</p>
<p>拓扑</p>
<p><img src="/images/erspan1-1.png" alt="erspan1-1 topo"></p>
<p>1/ IXIA向N9K-09推300pps的tcp流量，packet size == 2000</p>
<p>2/ N9K-09上配置了erspan将e1/4收到的流量copy一份，并发生到erspan destination 3172上，erspan传输路径如拓扑所示</p>
<p>3/ 为了控制erspan流量大小，在N9K做了erspan truncation，即在erspan session中配置了MTU 1000</p>
<p>4/ 3172上用ethanalyzer抓包，看不到任何erspan流量</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>1/ IXIA打出来的frame size以及原始IP header中的length是2000，启用erspan truncation后，frame size被强行截成1000+erspan header size，所以把沿途传输的erspan包抓下来如下，对于inner ip header，wireshark显示IPv4 total length exceed packet length</p>
<p><img src="/images/erspan1-3.png" alt="erspan1-3 topo"></p>
<p>N9K默认会检查包的IP header length部分，对于IP-IP tunnel的报文(此处是erspan)会检查内外层ip header的length做校验，和frame size进行比较，看是否有异常，所以这个包来说，由于包被截过，导致inner ip header length &gt; frame size，这样的包会被N9K-08认做错包，记output error错包从Po20，又N9K默认是cut-through模式，所以沿途N9K能看到的现象是，N9K-04入接口有input error，N9K-04出接口有output error，最后3172收到后也记input error，包在接口丢弃，故ethanalyzer抓不到erspan流量</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>关闭inner packet length校验功能，关闭后output error / input error问题消失，并且3172就能通过ethanalyzer收到所有erspan流量了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/10/copp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/10/copp/" itemprop="url">mtu-failure copp计数问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-10T09:12:11+08:00">
                2020-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>在与客户排查erspan丢包问题时产生的衍生问题，客户发现当现网有大量mtu-failure的流量(如SVI101 MTU1500，而实际需要穿越SVI101的packet size &gt; 1500)的时候，copp显示包丢在class-map copp-system-p-class-exception而非mtu-failure所在的copp-system-p-class-exception-diag里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">exception</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ip</span> <span class="title">option</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ip</span> <span class="title">icmp</span> <span class="title">unreachable</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ipv6</span> <span class="title">option</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ipv6</span> <span class="title">icmp</span> <span class="title">unreachable</span></span></span><br><span class="line"><span class="class">      <span class="title">set</span> <span class="title">cos</span> 1</span></span><br><span class="line">      police cir 150 kbps , bc 32000 bytes </span><br><span class="line">      module <span class="number">1</span> :</span><br><span class="line">        transmitted <span class="number">416162</span> bytes;</span><br><span class="line">        dropped <span class="number">23188</span> bytes;			&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 实际mtu-failure的流量都hit到这个<span class="class"><span class="keyword">class</span>-<span class="title">map</span>里</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">exception</span>-<span class="title">diag</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ttl</span>-<span class="title">failure</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">mtu</span>-<span class="title">failure</span>		&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; <span class="title">mtu</span>-<span class="title">failure</span>所在的<span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">exception</span>-<span class="title">diag</span>没有匹配到<span class="title">mtu</span>-<span class="title">failure</span>的流量</span></span><br><span class="line"><span class="class">      <span class="title">set</span> <span class="title">cos</span> 1</span></span><br><span class="line">      police cir 150 kbps , bc 32000 bytes </span><br><span class="line">      module <span class="number">1</span> :</span><br><span class="line">        transmitted <span class="number">0</span> bytes;</span><br><span class="line">        dropped <span class="number">0</span> bytes;</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>1/ LAB中测试往N9K打mtu-failure流量，问题能复现</p>
<p>2/ 目测正常行为，查文档看到有下面这句话可以解释这个现象</p>
<p>For Cisco Nexus 9200 Series switches, ip icmp redirect, ipv6 icmp redirect, ip icmp unreachable, ipv6 icmp unreachable, and mtu-failure use the same TCAM entry, and they will all be classified to the class map where the first exception is present in the policy. In the CoPP strict profile, they are classified to the class-exception class map. In a different CoPP policy, if the first exception is in a different class map (for example, class-exception-diag), the rest of the exceptions will be classified to the same class map.</p>
<p>这句话意思是ip icmp redirect, ipv6 icmp redirect, ip icmp unreachable, ipv6 icmp unreachable, and mtu-failure由于design上是写在同一个hardware TCAM entry里的，所以实际上这些exception是一起计数的，并且都会一起计数到第一个包含这些任意exception的class-map里。</p>
<p>3/ LAB举例说明一下，比如我手动定义COPP policy-map，只包含两个class-map class ip icmp unreachable和class default</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">N9K<span class="number">-08</span>(config-pmap)<span class="comment"># show policy-map interface control-plane</span></span><br><span class="line">Control Plane</span><br><span class="line"> </span><br><span class="line">  Service-policy  input: test</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">ip</span>-<span class="title">icmp</span>-<span class="title">unreachable</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ip</span> <span class="title">icmp</span> <span class="title">unreachable</span>                &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 我在这个<span class="title">class</span>-<span class="title">map</span>里只<span class="title">match</span>了<span class="title">ip</span> <span class="title">icmp</span> <span class="title">unreachable</span>的<span class="title">exception</span>流量</span></span><br><span class="line">      police cir 100000 bps , bc 32000 bytes </span><br><span class="line">      module <span class="number">1</span> :</span><br><span class="line">        transmitted <span class="number">119288</span> bytes;</span><br><span class="line">        dropped <span class="number">4719936</span> bytes;                           &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 往这台N9K打大量mtu-failure的tcp流量的时候，这个<span class="class"><span class="keyword">class</span>-<span class="title">map</span>的<span class="title">drop</span>就开始涨了</span></span><br><span class="line"><span class="class"> </span></span><br><span class="line"><span class="class">    <span class="title">class</span>-<span class="title">map</span> <span class="title">class</span>-<span class="title">default</span> <span class="params">(match-any)</span></span></span><br><span class="line">      police cir 10000 bps , bc 32000 bytes </span><br><span class="line">      module <span class="number">1</span> :</span><br><span class="line">        transmitted <span class="number">1514</span> bytes;</span><br><span class="line">        dropped <span class="number">0</span> bytes;</span><br><span class="line"></span><br><span class="line">这个现象的原因就如上面文档描述，ip icmp unreachable和mtu-failure这些exception是一起计数的</span><br></pre></td></tr></table></figure>

<p>再回到设备默认的COPP policy-map，默认包含exception的class-map顺序如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">N9K<span class="number">-08</span>(config)<span class="comment"># show policy-map interface control-plane | i exception prev 3</span></span><br><span class="line">  Service-policy  input: copp-system-p-policy-strict</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">l3uc</span>-<span class="title">data</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">glean</span></span></span><br><span class="line"><span class="class">--</span></span><br><span class="line">        dropped 0 bytes;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">l3mc</span>-<span class="title">data</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">multicast</span> <span class="title">rpf</span>-<span class="title">failure</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">multicast</span> <span class="title">dest</span>-<span class="title">miss</span></span></span><br><span class="line"><span class="class">--</span></span><br><span class="line">        transmitted 0 bytes;</span><br><span class="line">        dropped <span class="number">0</span> bytes;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">exception</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ip</span> <span class="title">option</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ip</span> <span class="title">icmp</span> <span class="title">unreachable</span>              </span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ipv6</span> <span class="title">option</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ipv6</span> <span class="title">icmp</span> <span class="title">unreachable</span></span></span><br><span class="line"><span class="class">--</span></span><br><span class="line">        transmitted 5147116 bytes;</span><br><span class="line">        dropped <span class="number">132431076</span> bytes;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">system</span>-<span class="title">p</span>-<span class="title">class</span>-<span class="title">exception</span>-<span class="title">diag</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">ttl</span>-<span class="title">failure</span></span></span><br><span class="line"><span class="class">      <span class="title">match</span> <span class="title">exception</span> <span class="title">mtu</span>-<span class="title">failure</span></span></span><br></pre></td></tr></table></figure>

<p>copp-system-p-class-exception是第一个包含ip icmp redirect, ipv6 icmp redirect, ip icmp unreachable, ipv6 icmp unreachable, and mtu-failure这些任意一个exception的class-map，所以这几个exception统统记录到class-map copp-system-p-class-exception里。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/10/hsrp-dual-active/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/10/hsrp-dual-active/" itemprop="url">N3548 hsrp双活，直连ping不通</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-10T07:58:20+08:00">
                2020-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>涉及的主机名/IP/MAC/端口编号已改</li>
</ul>
<h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>拓扑</p>
<p><img src="/images/arp1-1.png" alt="arp1-1 topo"></p>
<p>1/ N3548软件版本7.0(3)I7(6)</p>
<p>2/ SVI101这个hsrp instance双活dual active</p>
<p>3/ 客户反馈两边SVI101互ping不通，互联的物理口配置是trunk &amp; allow all vlan</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>先从SVI互ping不通的问题切入排查</p>
<p>1/ ping不通显示Destination Host Unreachable，说明3548-1解析不到3548-2 SVI101的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">N3548<span class="number">-1</span><span class="comment"># ping 10.1.1.3</span></span><br><span class="line">PING <span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span> (<span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span>): <span class="number">56</span> data bytes</span><br><span class="line"><span class="number">36</span> bytes <span class="keyword">from</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span>: Destination Host Unreachable</span><br><span class="line">Request <span class="number">0</span> timed out</span><br><span class="line"><span class="number">36</span> bytes <span class="keyword">from</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span>: Destination Host Unreachable</span><br><span class="line">^C</span><br><span class="line">--- <span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span> ping statistics ---</span><br><span class="line"><span class="number">2</span> packets transmitted, <span class="number">0</span> packets received, <span class="number">100.00</span>% packet loss</span><br><span class="line"></span><br><span class="line">N3548<span class="number">-1</span><span class="comment"># sh ip arp | i 10.1.213.3</span></span><br><span class="line"><span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span>      <span class="number">00</span>:<span class="number">00</span>:<span class="number">08</span>  INCOMPLETE      Vlan101	&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; INCOMPLETE</span><br></pre></td></tr></table></figure>

<p>2/ ping的时候在3548-1和3548-2上同时ethanalyzer arp，3548-1说自己发了arp request，3548-2却说自己没收到arp request</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">N3548-1#</span> <span class="string">ethanalyzer</span> <span class="string">local</span> <span class="string">interface</span> <span class="string">inband</span> <span class="string">display-filter</span> <span class="string">arp</span> <span class="string">limit-captured-frames</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="string">Capturing</span> <span class="string">on</span> <span class="string">inband</span></span><br><span class="line"><span class="attr">wireshark-cisco-mtc-dissector:</span> <span class="string">ethertype=0xde09,</span> <span class="string">devicetype=0x0</span></span><br><span class="line"></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-28</span> <span class="number">09</span><span class="string">:55:54.350286</span> <span class="string">7c:21:0e:2c:75:fc</span> <span class="string">-&gt;</span> <span class="string">ff:ff:ff:ff:ff:ff</span> <span class="string">ARP</span> <span class="string">Who</span> <span class="string">has</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span><span class="string">?</span>  <span class="string">Tell</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.2</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-28</span> <span class="number">09</span><span class="string">:55:58.356976</span> <span class="string">7c:21:0e:2c:75:fc</span> <span class="string">-&gt;</span> <span class="string">ff:ff:ff:ff:ff:ff</span> <span class="string">ARP</span> <span class="string">Who</span> <span class="string">has</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.3</span><span class="string">?</span>  <span class="string">Tell</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>

<p>3/ 在3548-2上清copp计数，随后在发起N35-1发起ping的时候，观察copp counter，发现只要N35-1 ping了几个包，N35-2 copp arp queue就显示丢几个包</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">N3548<span class="number">-1</span>共ping了<span class="number">3</span>个包后</span><br><span class="line"></span><br><span class="line">N3548<span class="number">-2</span><span class="comment"># show policy-map interface control-plane | i arp next 5</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">s</span>-<span class="title">arp</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">police</span> <span class="title">pps</span> 200 </span></span><br><span class="line"><span class="class">        <span class="title">HW</span> <span class="title">Matched</span> <span class="title">Packets</span>    9</span></span><br><span class="line"><span class="class">        <span class="title">SW</span> <span class="title">Matched</span> <span class="title">Packets</span>    6			&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; <span class="title">HW</span>表示硬件接口实际收到了多少包，<span class="title">SW</span>表示实际多少包上到上层<span class="title">arp</span>进程去处理，如果二者相等表示<span class="title">COPP</span>无丢包，如果二者不等，说明包被<span class="title">COPP</span>丢了，这里表明丢了3个包，正好和我们丢的3个<span class="title">ping</span>包能对上</span></span><br><span class="line"><span class="class">    <span class="title">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">s</span>-<span class="title">ptp</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">police</span> <span class="title">pps</span> 1000 </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">N3548</span>-1共<span class="title">ping</span>了4个包后</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">N3548</span>-2# <span class="title">show</span> <span class="title">policy</span>-<span class="title">map</span> <span class="title">interface</span> <span class="title">control</span>-<span class="title">plane</span> | <span class="title">i</span> <span class="title">arp</span> <span class="title">next</span> 5</span></span><br><span class="line"><span class="class">    <span class="title">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">s</span>-<span class="title">arp</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">police</span> <span class="title">pps</span> 200 </span></span><br><span class="line"><span class="class">        <span class="title">HW</span> <span class="title">Matched</span> <span class="title">Packets</span>    10</span></span><br><span class="line"><span class="class">        <span class="title">SW</span> <span class="title">Matched</span> <span class="title">Packets</span>    6			&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 这里表面丢了4个包，正好和我们丢的4个<span class="title">ping</span>包能对上</span></span><br><span class="line"><span class="class">    <span class="title">class</span>-<span class="title">map</span> <span class="title">copp</span>-<span class="title">s</span>-<span class="title">ptp</span> <span class="params">(match-any)</span></span></span><br><span class="line"><span class="class">      <span class="title">police</span> <span class="title">pps</span> 1000</span></span><br></pre></td></tr></table></figure>

<p>通过这一步明显看出包都丢在copp上了，但诡异的地方也在这里，上述输出可以看到copp为arp设置的阈值是200pps，理论上说N3548-2 CPU收到的arp速率得在200pps以上才会触发copp丢包才对，所以此处是个疑点，先mark</p>
<p>4/ 继续查看3548-2的syslog，发现过去两周内有一些接口flapping的log，这种flap有可能是trigger，但客户反馈不清楚故障发生的准确时间，所以也先mark</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">We can see e1/<span class="number">27</span>(unused port) staus change two week ago</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span> Apr <span class="number">14</span> <span class="number">09</span>:<span class="number">38</span>:<span class="number">46</span> N3548<span class="number">-2</span> %ETHPORT<span class="number">-5</span>-IF_HARDWARE: Interface Ethernet1/<span class="number">27</span>, hardware type changed to <span class="number">1</span>G</span><br><span class="line"><span class="number">2020</span> Apr <span class="number">14</span> <span class="number">09</span>:<span class="number">38</span>:<span class="number">55</span> N3548<span class="number">-2</span> %ETHPORT<span class="number">-5</span>-IF_HARDWARE: Interface Ethernet1/<span class="number">27</span>, hardware type changed to No-Transceiver</span><br><span class="line"><span class="number">2020</span> Apr <span class="number">14</span> <span class="number">09</span>:<span class="number">38</span>:<span class="number">56</span> N3548<span class="number">-2</span> %ETHPORT<span class="number">-5</span>-IF_DOWN_NONE: Interface Ethernet1/<span class="number">27</span> <span class="keyword">is</span> down (<span class="literal">None</span>)</span><br><span class="line"><span class="number">2020</span> Apr <span class="number">14</span> <span class="number">09</span>:<span class="number">40</span>:<span class="number">25</span> N3548<span class="number">-2</span> %VSHD<span class="number">-5</span>-VSHD_SYSLOG_CONFIG_I: Configured <span class="keyword">from</span> vty by admin on console0</span><br><span class="line"><span class="number">2020</span> Apr <span class="number">14</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">51</span> N3548<span class="number">-2</span> last message repeated <span class="number">1</span> time</span><br></pre></td></tr></table></figure>

<p>5/ 最后结合这些现象，hsrp双活以及arp无法解析的问题命中bug CSCvs97553 ARP/HSRP Cannot be punt to CPU after some link state change</p>
<p>bug症状与触发条件如下<br>In warp/normal mode, if the interface has some changes such as shutdown or unplugging the optical module,the remaining Layer 2 interfaces will fail to send ARP/HSRP packets to the CPU, whether unicast ARP or broadcast ARP.</p>
<p>Only 7.3(3)I7(6) and later will hit this issue</p>
<p>bug链接<br><a href="https://bst.cloudapps.cisco.com/bugsearch/bug/CSCvs97553" target="_blank" rel="noopener">https://bst.cloudapps.cisco.com/bugsearch/bug/CSCvs97553</a></p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>3548升级到修复版本I7(8)或者9.3(4)规避该bug</p>
<p>最后，客户反馈升级到I78后，故障解决，完结撒花。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/10/unable-to-get-address-from-dhcp-on-I77/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/10/unable-to-get-address-from-dhcp-on-I77/" itemprop="url">N9K I77下client无法通过dhcp获取地址</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-10T06:58:22+08:00">
                2020-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>拓扑</p>
<p><img src="/images/dhcp1-1.png" alt="dhcp1-1 topo"></p>
<p>1/ dhcp server与dhcp client直连N9K 7.0(3)I7(7)，并且同属VLAN103网段</p>
<p>2/ N9K通过连接client与server的端口的关键配置是LACP &amp; no lacp suspend-individual &amp; trunk native 103</p>
<p>3/ 客户反馈当有port-channel时，client无法从dhcp server获取地址，而当接口摘除port-channel配置后，就可以拿到地址</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>1/ 客户告知client网卡发包不会带上VLAN_TAG，所以N9K收到client的流量应该识别成native vlan 103<br>另外client在拿到地址前，client网卡是不会关联到LACP的，拿到地址后client网卡会自动关联到LACP mode，所以初始状态下客户需要在N9K上连接client的端口使用命令no lacp suspend-individual来避免N9K因收不到client过来的LACPDU而suspend物理口的情况，所以在该命令作用下，e1/2的初始状态是individual</p>
<p>2/ 由于是测试环境几乎没有流量，所以在故障状态下，用SPAN_TO_SPU的方式抓e1/2 rx的包，N9K可以抓到client发来的dhcp discover</p>
<p>3/ 在故障状态下，用SPAN_TO_CPU的方式抓e1/1 tx的包，N9K抓不到client发来的dhcp discover</p>
<p>4/ 通过2和3，确定丢包点是N9K，下一步就是做elam看丢包原因了，从elam结果中我们可以看到e1/2收到的discover包后，错误地识别成VLAN1，所以自然无法转发到同subnet VLAN103的dhcp server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SZYF-A1<span class="number">-201</span>-A06-T1<span class="number">-01</span><span class="number">-04</span><span class="number">-231.4</span>(TAH-elam-insel6)<span class="comment"># set outer l2 src_mac bbbb.bbbb.bbbb dst_mac ffff.ffff.ffff </span></span><br><span class="line">SZYF-A1<span class="number">-201</span>-A06-T1<span class="number">-01</span><span class="number">-04</span><span class="number">-231.4</span>(TAH-elam-insel6)<span class="comment"># start</span></span><br><span class="line">SZYF-A1<span class="number">-201</span>-A06-T1<span class="number">-01</span><span class="number">-04</span><span class="number">-231.4</span>(TAH-elam-insel6)<span class="comment"># report</span></span><br><span class="line">Initting block addresses</span><br><span class="line"></span><br><span class="line">SUGARBOWL ELAM REPORT SUMMARY</span><br><span class="line">slot - <span class="number">1</span>, asic - <span class="number">0</span>, slice - <span class="number">0</span></span><br><span class="line">============================</span><br><span class="line"></span><br><span class="line">Incoming Interface: Eth1/<span class="number">2</span>					&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; dhcp包从e1/<span class="number">2</span>进来</span><br><span class="line">Src Idx : <span class="number">0x5</span>, Src BD : <span class="number">1</span>					&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Src BD表示流量收到别识别成的VLAN_ID，此处有误，应该是VLAN103才对</span><br><span class="line">Outgoing Interface Info: met_ptr <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Packet Type: IPv4</span><br><span class="line"></span><br><span class="line">Dst MAC address: FF:FF:FF:FF:FF:FF</span><br><span class="line">Src MAC address: B8:BB:BB:BB:BB:BB</span><br><span class="line"></span><br><span class="line">Dst IPv4 address: <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span></span><br><span class="line">Src IPv4 address: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">Ver     =  <span class="number">4</span>, DSCP    =    <span class="number">4</span>, Don<span class="string">'t Fragment = 0</span></span><br><span class="line"><span class="string">Proto   = 17, TTL     =  128, More Fragments = 0</span></span><br><span class="line"><span class="string">Hdr len = 20, Pkt len =  328, Checksum       = 0x3996</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">L4 Protocol  : 17</span></span><br><span class="line"><span class="string">UDP Dst Port : 67</span></span><br><span class="line"><span class="string">UDP Src Port : 68</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Drop Info:									&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Drop Info要是不为空，通常表示这个包丢了，并且会记录drop reason</span></span><br><span class="line"><span class="string">----------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">LUA:</span></span><br><span class="line"><span class="string">LUB:</span></span><br><span class="line"><span class="string">LUC:</span></span><br><span class="line"><span class="string">LUD:</span></span><br><span class="line"><span class="string">  OUTER_IDS_G0</span></span><br><span class="line"><span class="string">Final Drops:</span></span><br><span class="line"><span class="string">ELAM not triggered yet on slot - 1, asic - 0, slice - 1</span></span><br></pre></td></tr></table></figure>

<p>5/ 用下面的命令发现l2一致性校验不通过，并且指示native vlan软硬件编程不同步，这也和上述elam结果一致</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">N9K<span class="comment"># sh consistency-checker l2 switchport interface ethernet 1/2</span></span><br><span class="line">Checking <span class="keyword">for</span> interface: Ethernet1/<span class="number">2</span></span><br><span class="line">SW <span class="keyword">and</span> HW trunk native VLAN <span class="keyword">not</span> same</span><br><span class="line">SW Trunk Native VLAN: <span class="number">103</span></span><br><span class="line">HW Trunk Native VLAN<span class="string">" 1</span></span><br><span class="line"><span class="string">Seoul2# 2020 Jan  8 13:22:56 Seoul2 %$ VDC-1 %$ vshd: CC_SWITCHPORT: Consistency Check: FAILED		&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span><br></pre></td></tr></table></figure>

<p>6/ 最后，这个问题是中了bug CSCvr81063 - Native VLAN hardware mis-programming happens in tah after upgrade to 7.0.3.I7.7 with LACP individual</p>
<p>触发条件就是N9K I77 &amp; N9K lacp suspend-individual &amp; client NIC non-lacp</p>
<p>bug链接：<br><a href="https://bst.cloudapps.cisco.com/bugsearch/bug/CSCvr81063" target="_blank" rel="noopener">https://bst.cloudapps.cisco.com/bugsearch/bug/CSCvr81063</a></p>
<p>bug smu链接：<br><a href="https://software.cisco.com/download/home/286312403/type/286278856/release/7.0(3)I7(7)?catid=268438038" target="_blank" rel="noopener">https://software.cisco.com/download/home/286312403/type/286278856/release/7.0(3)I7(7)?catid=268438038</a></p>
<h3 id="不改动现有配置的解决方法"><a href="#不改动现有配置的解决方法" class="headerlink" title="不改动现有配置的解决方法"></a>不改动现有配置的解决方法</h3><p>由于是中了BUG，并且该bug有SMU可打，所以解决方法自然是要么打SMU补丁，要么升级到bug修复版本</p>
<p>打SMU步骤可以参考如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">1</span>/ install add bootflash:nxos.CSCvr81063-n9k_ALL<span class="number">-1.0</span><span class="number">.0</span><span class="number">-7.0</span><span class="number">.3</span>.I7<span class="number">.7</span>.lib32_n9000.rpm</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>/ install activate nxos.CSCvr81063-n9k_ALL<span class="number">-1.0</span><span class="number">.0</span><span class="number">-7.0</span><span class="number">.3</span>.I7<span class="number">.7</span>.lib32_n9000.rpm</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>/ install commit nxos.CSCvr81063-n9k_ALL<span class="number">-1.0</span><span class="number">.0</span><span class="number">-7.0</span><span class="number">.3</span>.I7<span class="number">.7</span>.lib32_n9000.rpm</span><br></pre></td></tr></table></figure>

<p>最后客户反馈打上SMU后，一致性校验通过，故障解决，完结撒花。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/09/bgp-flapping-every-3-mins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cfc">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fucchen.dc">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/09/bgp-flapping-every-3-mins/" itemprop="url">bgp flapping every 3 mins</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-09T22:37:44+08:00">
                2020-05-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h3><p>拓扑</p>
<p><img src="/images/bgp-1-1.png" alt=""></p>
<p>1/ N9K-1与N9K-2直连，物理口L2，两端用loopback0(11.11/32与22.22/32)建IBGP邻居，两端loopback互相访问的出口是SVI10与e1/1</p>
<p>2/ 两端SVI10 MTU 9216, 两端e1/1 MTU 1500</p>
<p>3/ bgp每隔3分钟flap一次，log显示down的原因是holdtimer expire</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">2020</span> Apr <span class="number">20</span> <span class="number">18</span>:<span class="number">31</span>:<span class="number">02</span> switch %BGP<span class="number">-5</span>-ADJCHANGE:  bgp- [<span class="number">23416</span>] (default) neighbor <span class="number">22.22</span><span class="number">.22</span><span class="number">.22</span> Down - sent:  holdtimer expired error</span><br><span class="line"><span class="number">2020</span> Apr <span class="number">20</span> <span class="number">18</span>:<span class="number">31</span>:<span class="number">13</span> switch %BGP<span class="number">-5</span>-ADJCHANGE:  bgp- [<span class="number">23416</span>] (default) neighbor <span class="number">22.22</span><span class="number">.22</span><span class="number">.22</span> Up </span><br><span class="line"><span class="number">2020</span> Apr <span class="number">20</span> <span class="number">18</span>:<span class="number">34</span>:<span class="number">13</span> switch %BGP<span class="number">-5</span>-ADJCHANGE:  bgp- [<span class="number">23416</span>] (default) neighbor <span class="number">22.22</span><span class="number">.22</span><span class="number">.22</span> Down - sent:  holdtimer expired error</span><br><span class="line"><span class="number">2020</span> Apr <span class="number">20</span> <span class="number">18</span>:<span class="number">34</span>:<span class="number">24</span> switch %BGP<span class="number">-5</span>-ADJCHANGE:  bgp- [<span class="number">23416</span>] (default) neighbor <span class="number">22.22</span><span class="number">.22</span><span class="number">.22</span> Up </span><br><span class="line"><span class="number">2020</span> Apr <span class="number">20</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">24</span> switch %BGP<span class="number">-5</span>-ADJCHANGE:  bgp- [<span class="number">23416</span>] (default) neighbor <span class="number">22.22</span><span class="number">.22</span><span class="number">.22</span> Down - sent:  holdtimer expired error</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>在N9K-1上ethanalyzer抓包如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">93180</span><span class="number">-1</span>(config-<span class="keyword">if</span>)<span class="comment"># ethanalyzer local interface inband display-filter "ip.addr==11.11.11.11" limit-captured-frames 0</span></span><br><span class="line"></span><br><span class="line">Capturing on inband</span><br><span class="line">2020-04-21 14:37:46.113886  22.22.22.22 -&gt; 11.11.11.11  BGP NOTIFICATION Message</span><br><span class="line">2020-04-21 14:37:46.113932  11.11.11.11 -&gt; 22.22.22.22  TCP 27237 &gt; bgp [ACK] Seq=2646 Ack=22 Win=4588 Len=0 TSV=6362322 TSER=6515652</span><br><span class="line">2020-04-21 14:37:51.120379  22.22.22.22 -&gt; 11.11.11.11  TCP bgp &gt; 27237 [FIN, ACK] Seq=22 Ack=1 Win=4582 Len=0 TSV=6517154 TSER=6308321</span><br><span class="line">2020-04-21 14:37:51.121086  11.11.11.11 -&gt; 22.22.22.22  BGP KEEPALIVE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:37:51.121201  22.22.22.22 -&gt; 11.11.11.11  TCP bgp &gt; 27237 [RST] Seq=23 Win=0 Len=0</span><br><span class="line">2020-04-21 14:37:57.001783  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [SYN] Seq=0 Win=18352 Len=0 MSS=9176 TSV=6365589 TSER=0 WS=2</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;  TCP三次握手协商出MSS <span class="number">9176</span></span><br><span class="line"></span><br><span class="line">2020-04-21 14:37:57.001910  22.22.22.22 -&gt; 11.11.11.11  TCP bgp &gt; 31606 [SYN, ACK] Seq=0 Ack=1 Win=18328 Len=0 MSS=9176 TSV=6518918 TSER=6365589 WS=2</span><br><span class="line">2020-04-21 14:37:57.001968  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [ACK] Seq=1 Ack=1 Win=18352 Len=0 TSV=6365589 TSER=6518918</span><br><span class="line">2020-04-21 14:37:57.002650  22.22.22.22 -&gt; 11.11.11.11  BGP OPEN Message</span><br><span class="line">2020-04-21 14:37:57.002687  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [ACK] Seq=1 Ack=71 Win=18352 Len=0 TSV=6365589 TSER=6518918</span><br><span class="line">2020-04-21 14:37:57.137256  11.11.11.11 -&gt; 22.22.22.22  BGP OPEN Message</span><br><span class="line">2020-04-21 14:37:57.137362  22.22.22.22 -&gt; 11.11.11.11  TCP bgp &gt; 31606 [ACK] Seq=71 Ack=71 Win=18328 Len=0 TSV=6518959 TSER=6365629</span><br><span class="line">2020-04-21 14:37:57.138112  11.11.11.11 -&gt; 22.22.22.22  BGP KEEPALIVE Message</span><br><span class="line">2020-04-21 14:37:57.138180  22.22.22.22 -&gt; 11.11.11.11  TCP bgp &gt; 31606 [ACK] Seq=71 Ack=90 Win=18328 Len=0 TSV=6518959 TSER=6365630</span><br><span class="line">2020-04-21 14:37:57.150782  22.22.22.22 -&gt; 11.11.11.11  BGP KEEPALIVE Message</span><br><span class="line">2020-04-21 14:37:57.150812  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [ACK] Seq=90 Ack=90 Win=18352 Len=0 TSV=6365634 TSER=6518963</span><br><span class="line">2020-04-21 14:37:58.152430  11.11.11.11 -&gt; 22.22.22.22  BGP UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;  向外发大于<span class="number">1500</span>B的update                               </span><br><span class="line"></span><br><span class="line">2020-04-21 14:37:58.157457  22.22.22.22 -&gt; 11.11.11.11  BGP UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:37:58.157505  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [ACK] Seq=2735 Ack=198 Win=18352 Len=0 TSV=6365936 TSER=6519265</span><br><span class="line">2020-04-21 14:37:58.354040  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message   </span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;  大于<span class="number">1500</span>B的update大于对端物理口MTU，被视为jumbo直接丢弃，对面不回ACK，本端收不到ACK，不断重传</span><br><span class="line"></span><br><span class="line">2020-04-21 14:37:58.760702  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:37:59.574032  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:38:01.204036  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:38:04.464031  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:38:10.984024  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:38:24.024033  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:38:50.104020  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:38:58.163131  22.22.22.22 -&gt; 11.11.11.11  BGP KEEPALIVE Message</span><br><span class="line">2020-04-21 14:38:58.163193  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [ACK] Seq=2735 Ack=217 Win=18352 Len=0 TSV=6383937 TSER=6537267</span><br><span class="line">2020-04-21 14:39:42.317356  11.11.11.11 -&gt; 22.22.22.22  BGP [TCP Retransmission] UPDATE Message, UPDATE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:39:58.169396  22.22.22.22 -&gt; 11.11.11.11  BGP KEEPALIVE Message</span><br><span class="line">2020-04-21 14:39:58.169458  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [ACK] Seq=2735 Ack=236 Win=18352 Len=0 TSV=6401939 TSER=6555269</span><br><span class="line">2020-04-21 14:40:57.155907  22.22.22.22 -&gt; 11.11.11.11  BGP NOTIFICATION Message                                                                                                                                                                                  </span><br><span class="line">2020-04-21 14:40:57.155955  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [ACK] Seq=2735 Ack=257 Win=18352 Len=0 TSV=6419635 TSER=6572965</span><br><span class="line">2020-04-21 14:41:02.161130  11.11.11.11 -&gt; 22.22.22.22  BGP KEEPALIVE Message, KEEPALIVE Message</span><br><span class="line">2020-04-21 14:41:02.161252  22.22.22.22 -&gt; 11.11.11.11  TCP [TCP Dup ACK 5137#1] bgp &gt; 31606 [ACK] Seq=257 Ack=90 Win=18328 Len=0 TSV=6574466 TSER=6365634 SLE=2735 SRE=2774</span><br><span class="line">2020-04-21 14:41:02.162420  22.22.22.22 -&gt; 11.11.11.11  TCP bgp &gt; 31606 [FIN, ACK] Seq=257 Ack=90 Win=18328 Len=0 TSV=6574467 TSER=6365634 SLE=2735 SRE=2774</span><br><span class="line">2020-04-21 14:41:02.162451  11.11.11.11 -&gt; 22.22.22.22  TCP 31606 &gt; bgp [ACK] Seq=2774 Ack=258 Win=18352 Len=0 TSV=6421137 TSER=6574467</span><br></pre></td></tr></table></figure>

<p>要点</p>
<p>1/ 在BGP邻居建立前的进行TCP三次握手中，可以看到MSS协商成了9176</p>
<p>2/ BGP建邻居用的Open报文都是小包(size &lt; 1500)正常收发，bgp邻居正常建立</p>
<p>3/ bgp邻居建立后，下一步是通告bgp update，bgp Update报文size上限由TCP MSS决定，所以此处BGP Update size最大可以达到9176，<br>bgp通告路由时会将多个NLRI路由信息裹在一个Update报文里，所以当邻居up后，需要通告的路由较多时，很容易出现Update size &gt; 1500 的情况出现，bgp Update size &gt; 物理口e1/1的MTU 1500，所以N9K-1将该包记output error &amp; jumbo将包从e1/1发出，N9K-2收到包记input error &amp; jumbo，并在接口层面丢弃该报文，所以上层tcp &amp; bgp实际上并没有收到这个tcp based update，自然也不会回复ack，所以我们看到N9K-1由于收不到ack，不断重传</p>
<p>4/ 仔细观察Update报文部分，会发现keepalive报文也是裹在jumbo frame的bgp update作为同一个传输的，所以keepalive也是被N9K-2直接丢弃的并且没有ack，所以N9K-1在连续三次发出的Keepalive(60s * 3 == 180s/3mins)没有被ack后，触发holdtime expire，邻居被重置，然后一直循环这4个步骤</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>1/沿途涉及的L2/L3接口MTU统一成9216</p>
<p>2/两端配置pmtud，启用后pmtud协商出较小的MSS值，如下输出协商成了1024，所以后续bgp update不会大于这个size</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">93180</span><span class="number">-1</span>(config-<span class="keyword">if</span>)<span class="comment">#  show sockets connection local 11.11.11.11 foreign 22.22.22.22 detail </span></span><br><span class="line"></span><br><span class="line">Total number of netstack tcp sockets: <span class="number">5</span></span><br><span class="line">Active connections (including servers)</span><br><span class="line"></span><br><span class="line">Total number of netstack udp sockets: <span class="number">9</span></span><br><span class="line">Active connections (including servers)</span><br><span class="line"></span><br><span class="line">Total number of netstack raw sockets: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Kernel Socket Connection:</span><br><span class="line">State      Recv-Q Send-Q        Local Address:Port          Peer Address:Port </span><br><span class="line"></span><br><span class="line">ESTAB      <span class="number">0</span>      <span class="number">0</span>               <span class="number">11.11</span><span class="number">.11</span><span class="number">.11</span>:<span class="number">179</span>            <span class="number">22.22</span><span class="number">.22</span><span class="number">.22</span>:<span class="number">54435</span>  ino:<span class="number">133796</span> sk:ffff8805d0e31a00</span><br><span class="line"></span><br><span class="line">         skmem:(r0,rb262144,t0,tb262144,f0,w0,o0) ts sack cubic wscale:<span class="number">2</span>,<span class="number">2</span> rto:<span class="number">203.333</span> rtt:<span class="number">3.333</span>/<span class="number">1.666</span> ato:<span class="number">40</span> mss:<span class="number">1024</span> cwnd:<span class="number">5</span> ssthresh:<span class="number">7</span> send <span class="number">12.3</span>Mbps rcv_space:<span class="number">18328</span></span><br></pre></td></tr></table></figure>

<h3 id="附LAB复现方法"><a href="#附LAB复现方法" class="headerlink" title="附LAB复现方法"></a>附LAB复现方法</h3><p>LAB找两台N9K用如上拓扑连接，然后在N9K-1上通过脚本创建大量loopback，并将其network到bgp中，通告给N9K-2。复现这个故障最关键地方是需要保证bgp up后，向peer通告的路由数量要足够多，Update size需要大于1500</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> cli <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">509</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">if</span> i &lt;= <span class="number">254</span>:</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">print</span> <span class="string">'conf t ; interface loopback'</span> + str(i) + <span class="string">' ; ip address 1.1.1.'</span> + str(i) + <span class="string">'/32'</span></span><br><span class="line"><span class="meta">... </span>        cli(<span class="string">'conf t ; interface loopback'</span> + str(i) + <span class="string">' ; ip address 1.1.1.'</span> + str(i) + <span class="string">'/32'</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">print</span> <span class="string">'conf t ; interface loopback'</span> + str(i) + <span class="string">' ; ip address 1.1.2.'</span> + str(i<span class="number">-254</span>) + <span class="string">'/32'</span></span><br><span class="line"><span class="meta">... </span>        cli(<span class="string">'conf t ; interface loopback'</span> + str(i) + <span class="string">' ; ip address 1.1.2.'</span> + str(i<span class="number">-254</span>) + <span class="string">'/32'</span>)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line">conf t ; interface loopback0 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback1 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback2 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.2</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback3 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.3</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback4 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.4</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback5 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.5</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback6 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.6</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback7 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.7</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback8 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.8</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line">conf t ; interface loopback9 ; ip address <span class="number">1.1</span><span class="number">.1</span><span class="number">.9</span>/<span class="number">32</span></span><br><span class="line"><span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>quit()</span><br><span class="line"> Redistribute the <span class="number">500</span> loopbacks into BGP to create a large size BGP UPDATE</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">ip prefix-list LOCAL-TO-BGP seq <span class="number">5</span> permit <span class="number">1.1</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span> ge <span class="number">25</span> </span><br><span class="line">ip prefix-list LOCAL-TO-BGP seq <span class="number">10</span> permit <span class="number">1.1</span><span class="number">.2</span><span class="number">.0</span>/<span class="number">24</span> ge <span class="number">25</span></span><br><span class="line">!</span><br><span class="line">route-map LOCAL-TO-BGP permit <span class="number">10</span></span><br><span class="line">  match ip address prefix-list LOCAL-TO-BGP </span><br><span class="line">!</span><br><span class="line">router bgp <span class="number">64512</span></span><br><span class="line">  timers bgp <span class="number">3</span> <span class="number">9</span></span><br><span class="line">  address-family ipv4 unicast</span><br><span class="line">    redistribute direct route-map LOCAL-TO-BGP</span><br></pre></td></tr></table></figure>





          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">cfc</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cfc</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
